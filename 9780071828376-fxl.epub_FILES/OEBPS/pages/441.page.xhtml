<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title/><link rel="stylesheet" href="../css/base.min.css"/><link rel="stylesheet" href="../css/fancy.min.css"/><link rel="stylesheet" href="../css/pdf.css"/><meta name="viewport" content="width=640, height=824"/></head><body><div id="page_body"><div id="pf1b9" class="pf w2 h2" data-page-no="1b9"><div class="pc pc1b9 w2 h2"><img class="bi xaf y27a8 w4 h9e" alt="" src="bg1b9.png"/><div class="t m0 xbe h10 y83 ff1 fs9 fc0 sc0 lsa ws0">418<span class="_ _d"> </span><span class="ff2 fs2 ls8">Advanced Persistent Threat Hacking<span class="_ _1e"/> </span></div><div class="t m0 x3 h7 y27a9 ff1 fs3 fc0 sc0 ls0 ws0">W<span class="_ _0"/>atchdog: Backdoor Persistence</div><div class="t m0 x3 hd y27aa ff4 fs7 fc0 sc0 ls0 ws0">W<span class="_ _3"/>e’ll use the W<span class="_ _2"/>indows calculator program (calc.e<span class="_ _0"/>xe) as the e<span class="_ _0"/>xample here to make </div><div class="t m0 x3 hd y27ab ff4 fs7 fc0 sc0 ls0 ws0">our testing easy<span class="_ _2"/>. Using an example from the Microsoft De<span class="_ _0"/>veloper Netw<span class="_ _0"/>ork (MSDN) </div><div class="t m0 x3 hd y27ac ff4 fs7 fc0 sc0 ls0 ws0">on the use of the EnumProcesses and OpenProcess functions, we’ll modify it to </div><div class="t m0 x3 hd y27ad ff4 fs7 fc0 sc0 ls0 ws0">watch for a specic process name and then react accordingly whether the process is </div><div class="t m0 x3 hd y27ae ff4 fs7 fc0 sc0 ls0 ws0">running or not. The original code can be found at http://msdn.microsoft.com/en-us/</div><div class="t m0 x3 hd y27af ff4 fs7 fc0 sc0 ls0 ws0">library/ms682623%28v=vs.85%29.aspx. The follo<span class="_ _0"/>wing sho<span class="_ _0"/>ws a simple example of </div><div class="t m0 x3 hd y27b0 ff4 fs7 fc0 sc0 ls0 ws0">monitoring for the calc.ex<span class="_ _0"/>e process:</div><div class="t m0 x3 h40 y27b1 fff fs5 fc0 sc0 ls0 ws0">#include &lt;windows.h&gt;</div><div class="t m0 x3 h40 y27b2 fff fs5 fc0 sc0 ls0 ws0">#include &lt;stdio.h&gt;</div><div class="t m0 x3 h40 y27b3 fff fs5 fc0 sc0 ls0 ws0">#include &lt;tchar.h&gt;</div><div class="t m0 x3 h40 y27b4 fff fs5 fc0 sc0 ls0 ws0">#include &lt;psapi.h&gt;</div><div class="t m0 x3 h40 y27b5 fff fs5 fc0 sc0 ls0 ws0">#define EXENAME "calc.exe"</div><div class="t m0 x3 h21 y27b6 ff1 fs2 fc0 sc0 ls0 ws0">Figure 10-1<span class="_ _21"> </span><span class="ffc">Firewalled host; DNS request hits our ser<span class="_ _1"/>ver</span></div><div class="t m0 xdb h22 y27b7 ffd fs5 fc0 sc0 ls0 ws0">Our DNS server</div><div class="t m0 x4d h22 y27b8 ffd fs5 fc0 sc0 ls0 ws0">logs the lookup</div><div class="t m0 xf0 h22 y27b9 ffd fs5 fc0 sc0 ls0 ws0">request</div><div class="t m0 x12 h22 y27ba ffd fs5 fc0 sc0 ls0 ws0"><span class="fc5 sc0">In</span>ternet DNS</div><div class="t m0 xe1 h22 y27bb ffd fs5 fc0 sc0 ls0 ws0">server</div><div class="t m0 xf1 h22 y27bc ffd fs5 fc0 sc0 ls0 ws0">Backdoored</div><div class="t m0 xe8 h22 y27bd ffd fs5 fc0 sc0 ls0 ws0">computer</div><div class="t m0 x1c h22 y27be ffd fs5 fc0 sc0 ls0 ws0">Host 1</div><div class="t m0 x8c h22 y27bf ffd fs5 fc0 sc0 ls0 ws0">Block all outb<span class="fc5 sc0">ound</span></div><div class="t m0 xf2 h22 y27c0 ffd fs5 fc0 sc0 ls0 ws0">communication fr<span class="fc5 sc0">om host1</span></div><div class="t m0 xf3 h22 y27bf ffd fs5 fc0 sc0 ls0 ws0"><span class="fc5 sc0">Firewall a</span>llows outbound DNS</div><div class="t m0 xd9 h22 y27c0 ffd fs5 fc0 sc0 ls0 ws0"><span class="fc5 sc0">requests </span>from internal server</div><div class="t m0 xef h22 y27c1 ffd fs5 fc0 sc0 ls0 ws0">Server 1</div><div class="t m0 x5d h22 y27c2 ffd fs5 fc0 sc0 ls0 ws0">Firewall</div><div class="t m0 xa3 h22 y27c3 ffd fs5 fc0 sc0 ls0 ws0">Internet</div><a class="" href="http://msdn.microsoft.com/en-us/library/ms682623%28v=vs.85%29.aspx"><div class="d m1" style="border-style:none;position:absolute;left:359.304611px;bottom:217.735450px;width:146.000000px;height:12.000000px;background-color:rgba(255,255,255,0.000001);"/></a><a class="" href="http://msdn.microsoft.com/en-us/library/ms682623%28v=vs.85%29.aspx"><div class="d m1" style="border-style:none;position:absolute;left:94.452003px;bottom:202.013605px;width:179.000000px;height:12.000000px;background-color:rgba(255,255,255,0.000001);"/></a></div><div class="pi" data-data="{&#34;ctm&#34;:[1.209373,0.000000,0.000000,1.209373,0.000000,0.000000]}"/></div></div></body></html>