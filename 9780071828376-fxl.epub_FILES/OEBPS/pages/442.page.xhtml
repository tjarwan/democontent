<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title/><link rel="stylesheet" href="../css/base.min.css"/><link rel="stylesheet" href="../css/fancy.min.css"/><link rel="stylesheet" href="../css/pdf.css"/><meta name="viewport" content="width=640, height=824"/></head><body><div id="page_body"><div id="pf1ba" class="pf w2 h2" data-page-no="1ba"><div class="pc pc1ba w2 h2"><div class="t m0 x6 h10 y83 ff2 fs2 fc0 sc0 ls8 ws0">Chapter 10: APT Software Backdoors<span class="_ _9"> </span><span class="ff1 fs9 lsa">419</span></div><div class="t m0 x3 h40 ya7f fff fs5 fc0 sc0 ls0 ws0">int main( void )</div><div class="t m0 x3 h40 ya80 fff fs5 fc0 sc0 ls0 ws0">{</div><div class="t m0 x3 h40 ya81 fff fs5 fc0 sc0 ls0 ws0">    // Get the list of process identifiers.</div><div class="t m0 x3 h40 ya82 fff fs5 fc0 sc0 ls0 ws0">    DWORD aProcesses[1024], cbNeeded, cProcesses;</div><div class="t m0 x3 h40 y259c fff fs5 fc0 sc0 ls0 ws0">    DWORD processID;</div><div class="t m0 x3 h40 y259d fff fs5 fc0 sc0 ls0 ws0">    unsigned int i;</div><div class="t m0 x3 h40 y25c1 fff fs5 fc0 sc0 ls0 ws0"> // Loop indefinitely</div><div class="t m0 x3 h40 y25c2 fff fs5 fc0 sc0 ls0 ws0">while ( 0 == 0 )</div><div class="t m0 x3 h40 y25c3 fff fs5 fc0 sc0 ls0 ws0">{</div><div class="t m0 x3 h40 y27c4 fff fs5 fc0 sc0 ls0 ws0">    if ( !EnumProcesses( aProcesses, sizeof(aProcesses), &amp;cbNeeded ) )</div><div class="t m0 x3 h40 y27c5 fff fs5 fc0 sc0 ls0 ws0">    {</div><div class="t m0 x3 h40 y27c6 fff fs5 fc0 sc0 ls0 ws0">        return 1;</div><div class="t m0 x3 h40 y261d fff fs5 fc0 sc0 ls0 ws0">    }</div><div class="t m0 x3 h40 y27c7 fff fs5 fc0 sc0 ls0 ws0">    // Calculate how many process identifiers were returned.</div><div class="t m0 x3 h40 y27c8 fff fs5 fc0 sc0 ls0 ws0">    cProcesses = cbNeeded / sizeof(DWORD);</div><div class="t m0 x3 h40 y27c9 fff fs5 fc0 sc0 ls0 ws0">    int procRunning = 0;</div><div class="t m0 x3 h40 y27ca fff fs5 fc0 sc0 ls0 ws0">    for ( i = 0; i &lt; cProcesses; i++ )</div><div class="t m0 x3 h40 y27cb fff fs5 fc0 sc0 ls0 ws0">    {</div><div class="t m0 x3 h40 y263a fff fs5 fc0 sc0 ls0 ws0">        if( aProcesses[i] != 0 )</div><div class="t m0 x3 h40 y27cc fff fs5 fc0 sc0 ls0 ws0">        {</div><div class="t m0 x3 h40 y27cd fff fs5 fc0 sc0 ls0 ws0">           // aProcesses[i] </div><div class="t m0 x3 h40 y27ce fff fs5 fc0 sc0 ls0 ws0">           processID = aProcesses[i];</div><div class="t m0 x3 h40 y27cf fff fs5 fc0 sc0 ls0 ws0">           TCHAR szProcessName[MAX_PATH] = TEXT("&lt;unknown&gt;");</div><div class="t m0 x3 h40 y272c fff fs5 fc0 sc0 ls0 ws0">    // Get a handle to the process.</div><div class="t m0 x3 h40 y27d0 fff fs5 fc0 sc0 ls0 ws0">    HANDLE hProcess = OpenProcess( PROCESS_QUERY_INFORMATION |</div><div class="t m0 x3 h40 y27d1 fff fs5 fc0 sc0 ls0 ws0">                                   PROCESS_VM_READ,</div><div class="t m0 x3 h40 y27d2 fff fs5 fc0 sc0 ls0 ws0">                                   FALSE, processID );</div><div class="t m0 x3 h40 y27d3 fff fs5 fc0 sc0 ls0 ws0">    if (NULL != hProcess )</div><div class="t m0 x3 h40 y27d4 fff fs5 fc0 sc0 ls0 ws0">    {</div><div class="t m0 x3 h40 y27d5 fff fs5 fc0 sc0 ls0 ws0">        HMODULE hMod;</div><div class="t m0 x3 h40 y27d6 fff fs5 fc0 sc0 ls0 ws0">        DWORD cbNeeded;</div><div class="t m0 x3 h40 y27d7 fff fs5 fc0 sc0 ls0 ws0">        if ( EnumProcessModules( hProcess, &amp;hMod, sizeof(hMod), </div><div class="t m0 x3 h40 y27d8 fff fs5 fc0 sc0 ls0 ws0">             &amp;cbNeeded) )</div><div class="t m0 x3 h40 y27d9 fff fs5 fc0 sc0 ls0 ws0">        {</div><div class="t m0 x3 h40 y27da fff fs5 fc0 sc0 ls0 ws0">            GetModuleBaseName( hProcess, hMod, szProcessName, </div><div class="t m0 x3 h40 y27db fff fs5 fc0 sc0 ls0 ws0">                               sizeof(szProcessName)/sizeof(TCHAR) );</div><div class="t m0 x3 h40 y27dc fff fs5 fc0 sc0 ls0 ws0">        }</div><div class="t m0 x3 h40 y27dd fff fs5 fc0 sc0 ls0 ws0">    }</div></div><div class="pi" data-data="{&#34;ctm&#34;:[1.209373,0.000000,0.000000,1.209373,0.000000,0.000000]}"/></div></div></body></html>