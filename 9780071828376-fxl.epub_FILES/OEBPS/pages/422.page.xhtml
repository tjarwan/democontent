<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title/><link rel="stylesheet" href="../css/base.min.css"/><link rel="stylesheet" href="../css/fancy.min.css"/><link rel="stylesheet" href="../css/pdf.css"/><meta name="viewport" content="width=640, height=824"/></head><body><div id="page_body"><div id="pf1a6" class="pf w2 h2" data-page-no="1a6"><div class="pc pc1a6 w2 h2"><div class="t m0 x6 h10 y83 ff2 fs2 fc0 sc0 ls8 ws0">Chapter 10: APT Software Backdoors<span class="_ _9"> </span><span class="ff1 fs9 lsa">399</span></div><div class="t m0 x3 h40 ya7f fff fs5 fc0 sc0 ls0 ws0">  else</div><div class="t m0 x3 h40 ya80 fff fs5 fc0 sc0 ls0 ws0">  {</div><div class="t m0 x3 h40 ya81 fff fs5 fc0 sc0 ls0 ws0">   /* the current directory is the last directory we'll try </div><div class="t m0 x3 h40 ya82 fff fs5 fc0 sc0 ls0 ws0">   Assuming PWD is writable, should perform check */ </div><div class="t m0 x3 h40 y259c fff fs5 fc0 sc0 ls0 ws0">   memset( curDir, '\0', sizeof(curDir) );</div><div class="t m0 x3 h40 y259d fff fs5 fc0 sc0 ls0 ws0">   GetCurrentDirectory( MAXPATH, curDir);</div><div class="t m0 x3 h40 y25c1 fff fs5 fc0 sc0 ls0 ws0">   strcat( curDir, "\\"); // add final backslash for directory</div><div class="t m0 x3 h40 y25c2 fff fs5 fc0 sc0 ls0 ws0">   strcat( outDirName, curDir );</div><div class="t m0 x3 h40 y25c3 fff fs5 fc0 sc0 ls0 ws0">   }</div><div class="t m0 x3 h40 y25c4 fff fs5 fc0 sc0 ls0 ws0">  }</div><div class="t m0 x3 h40 y25c5 fff fs5 fc0 sc0 ls0 ws0"> return 0;</div><div class="t m0 x3 h40 y25c6 fff fs5 fc0 sc0 ls0 ws0">}</div><div class="t m0 x4 hd y1780 ff4 fs7 fc0 sc0 ls0 ws0">The ndWritableDirectory function takes only one ar<span class="_ _0"/>gument, which is the </div><div class="t m0 x3 hd y25c7 ff4 fs7 fc0 sc0 ls0 ws0">destination character array to sav<span class="_ _0"/>e the directory name to. This function scans a fe<span class="_ _0"/>w </div><div class="t m0 x3 hd y1782 ff4 fs7 fc0 sc0 ls0 ws0">predened directories to identify a location that the current user has write access to. </div><div class="t m0 x3 hd y25c8 ff4 fs7 fc0 sc0 ls0 ws0">In this example, we’<span class="_ _2"/>re scanning the following three directories:</div><div class="t m0 x16 h1f y25c9 ffb fse fc0 sc0 ls0 ws0">c</div><div class="t m0 x1 hd y25ca ff4 fs7 fc0 sc0 ls0 ws0">Local application data – en<span class="_ _0"/>vironment v<span class="_ _0"/>ariable</div><div class="t m0 x16 h1f y25cb ffb fse fc0 sc0 ls0 ws0">c</div><div class="t m0 x1 hd y25cc ff4 fs7 fc0 sc0 ls0 ws0">User prole – en<span class="_ _0"/>vironment v<span class="_ _0"/>ariable</div><div class="t m0 x16 h1f y25cd ffb fse fc0 sc0 ls0 ws0">c</div><div class="t m0 x1 hd y25ce ff4 fs7 fc0 sc0 ls0 ws0">Current working directory</div><div class="t m0 x4 hd y25cf ff4 fs7 fc0 sc0 ls0 ws0">W<span class="_ _3"/>e’<span class="_ _0"/>ve obtained the en<span class="_ _2"/>vironment variable by using the GetEn<span class="_ _0"/>vironmentV<span class="_ _1b"/>ariable </div><div class="t m0 x3 hd y25d0 ff4 fs7 fc0 sc0 ls0 ws0">W<span class="_ _0"/>indo<span class="_ _0"/>ws <span class="_ _2"/>API function. The default location for the LOCALAPPD<span class="_ _2"/>A<span class="_ _3"/>T<span class="_ _3"/>A variable is </div><div class="t m0 x3 hd y25d1 ff4 fs7 fc0 sc0 ls0 ws0">C:\Users\N<span class="_ _0"/>AME\AppData\Local\, while the default location for the USERPR<span class="_ _2"/>OFILE </div><div class="t m0 x3 hd y25d2 ff4 fs7 fc0 sc0 ls0 ws0">en<span class="_ _0"/>vironment v<span class="_ _0"/>ariable is C:\Users\N<span class="_ _0"/>AME\. <span class="_ _0"/>The current working directory will be the </div><div class="t m0 x3 hd y25d3 ff4 fs7 fc0 sc0 ls0 ws0">directory that the dropper is ex<span class="_ _0"/>ecuting from. Thus, we w<span class="_ _0"/>ould only want to use the </div><div class="t m0 x3 hd y25d4 ff4 fs7 fc0 sc0 ls0 ws0">current directory when the user has do<span class="_ _0"/>wnloaded the dropper and not in cases where </div><div class="t m0 x3 hd y25d5 ff4 fs7 fc0 sc0 ls0 ws0">it is on a USB or CD dri<span class="_ _0"/>ve.</div><div class="t m0 x4 hd y25d6 ff4 fs7 fc0 sc0 ls0 ws0">Although it would be easy to programmatically iterate through all of the </div><div class="t m0 x3 hd y25d7 ff4 fs7 fc0 sc0 ls0 ws0">directories on the le system, we don’t w<span class="_ _0"/>ant to risk the chance of the backdoor </div><div class="t m0 x3 hd y25d8 ff4 fs7 fc0 sc0 ls0 ws0">being installed in an obviously inappropriate directory (such as the user's desktop). </div><div class="t m0 x3 hd y25d9 ff4 fs7 fc0 sc0 ls0 ws0">Ultimately<span class="_ _2"/>, if we’<span class="_ _0"/>re able to obtain administrator or system-le<span class="_ _0"/>vel access, this will be </div><div class="t m0 x3 hd y25da ff4 fs7 fc0 sc0 ls0 ws0">a moot point, as we can hide our directory and rootkit les where<span class="_ _0"/>ver we choose, b<span class="_ _0"/>ut </div><div class="t m0 x3 hd y25db ff4 fs7 fc0 sc0 ls0 ws0">we still want to be selecti<span class="_ _0"/>ve of where we place it.</div><div class="t m0 x4 hd y25dc ff4 fs7 fc0 sc0 ls0 ws0">W<span class="_ _3"/>e use the ndWritableDirectory function to rst identify a directory we can </div><div class="t m0 x3 hd y25dd ff4 fs7 fc0 sc0 ls0 ws0">write to and then we use that directory as the destination to do<span class="_ _0"/>wnload and sav<span class="_ _0"/>e </div><div class="t m0 x3 hd y25de ff4 fs7 fc0 sc0 ls0 ws0">the backdoor<span class="_ _0"/>, as in the follo<span class="_ _0"/>wing example. <span class="_ _1b"/>Y<span class="_ _3"/>ou can see we rst identify a writable </div><div class="t m0 x3 hd y25df ff4 fs7 fc0 sc0 ls0 ws0">directory with ndWritableDirectory and then create the full ex<span class="_ _0"/>ecutable path, which </div></div><div class="pi" data-data="{&#34;ctm&#34;:[1.209373,0.000000,0.000000,1.209373,0.000000,0.000000]}"/></div></div></body></html>