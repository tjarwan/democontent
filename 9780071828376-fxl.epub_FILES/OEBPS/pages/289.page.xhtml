<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title/><link rel="stylesheet" href="../css/base.min.css"/><link rel="stylesheet" href="../css/fancy.min.css"/><link rel="stylesheet" href="../css/pdf.css"/><meta name="viewport" content="width=640, height=824"/></head><body><div id="page_body"><div id="pf121" class="pf w2 h2" data-page-no="121"><div class="pc pc121 w2 h2"><div class="t m0 xbe h10 y83 ff1 fs9 fc0 sc0 lsa ws0">266<span class="_ _d"> </span><span class="ff2 fs2 ls8">Advanced Persistent Threat Hacking<span class="_ _1e"/> </span></div><div class="t m0 x3 hd y11c ff4 fs7 fc0 sc0 ls0 ws0">to help dif<span class="_ _0"/>ferentiate between the different log les. In addition, we ha<span class="_ _0"/>v<span class="_ _0"/>e some nativ<span class="_ _0"/>e </div><div class="t m0 x3 hd y11d ff4 fs7 fc0 sc0 ls0 ws0">log functionality that is helpful for us—most notably<span class="_ _2"/>, the <span class="_ _0"/>Apache web serv<span class="_ _0"/>er logs </div><div class="t m0 x3 hd y20f ff4 fs7 fc0 sc0 ls0 ws0">and DHCP server logs. <span class="_ _0"/>The <span class="_ _2"/>Apache log les of most interest to us are, by default, </div><div class="t m0 x3 hd y210 ff4 fs7 fc0 sc0 ls0 ws0">in the /v<span class="_ _0"/>ar/log/apache2/ directory<span class="_ _2"/>. The access.log le sho<span class="_ _0"/>ws us all of the requested </div><div class="t m0 x3 hd y211 ff4 fs7 fc0 sc0 ls0 ws0">URLs, the source IP address, the timestamp of when it was requested, and the user </div><div class="t m0 x3 hd y212 ff4 fs7 fc0 sc0 ls0 ws0">agent of the bro<span class="_ _0"/>wser! <span class="_ _0"/>All of this can be v<span class="_ _0"/>aluable information to analyze and create </div><div class="t m0 x3 hd y213 ff4 fs7 fc0 sc0 lsb ws16">an e<span class="_ _0"/>ven more tar<span class="_ _0"/>geted attack against the system. The DHCP serv<span class="_ _0"/>er lease le can be </div><div class="t m0 x3 hd y1654 ff4 fs7 fc0 sc0 ls0 ws0">inspected as a central place to obtain the IP address, MA<span class="_ _0"/>C address, and hostname of </div><div class="t m0 x3 hd y16f3 ff4 fs7 fc0 sc0 ls0 ws0">any system on our access point. <span class="_ _0"/>The default location of the lease le is /v<span class="_ _0"/>ar/lib/dhcp/</div><div class="t m0 x3 hd y16f4 ff4 fs7 fc0 sc0 ls0 ws0">dhcpd.leases.</div><div class="t m0 x3 h4 y1bdc ff2 fs1 fc0 sc0 ls0 ws0">Access Point Protocol Manipulation</div><div class="t m0 x3 hd y494 ff4 fs7 fc0 sc0 ls0 ws0">The main function of our iptables re<span class="_ _0"/>wall conguration will be to redirect unicast </div><div class="t m0 x3 hd ybfd ff4 fs7 fc0 sc0 ls0 ws0">packets sourced from the client de<span class="_ _0"/>vice and destined to an arbitrary IP address on the </div><div class="t m0 x3 hd y1bdd ff4 fs7 fc0 sc0 ls0 ws0">Internet and redirect it to our host. This is especially important for the f<span class="_ _0"/>ake servers </div><div class="t m0 x3 hd y1bde ff4 fs7 fc0 sc0 ls0 ws0">we’<span class="_ _2"/>ve congured. The <span class="_ _2"/>ARAP package comes with an iptables script that will redirect </div><div class="t m0 x3 hd y1bdf ff4 fs7 fc0 sc0 ls0 ws0">e<span class="_ _0"/>very single port from 1 to 65535 to our serv<span class="_ _0"/>er<span class="_ _0"/>. <span class="_ _0"/>T<span class="_ _3"/>o congure iptables on the server<span class="_ _0"/>, </div><div class="t m0 x3 hd y1be0 ff4 fs7 fc0 sc0 ls0 ws0">you can simply ex<span class="_ _0"/>ecute the script provided with the <span class="_ _2"/>ARAP package as follows:</div><div class="t m0 x3 h44 yc93 fff fse fc0 sc0 ls0 ws0">root@kali:~/arap# ./iptables.sh</div><div class="t m0 x4 hd y1be1 ff4 fs7 fc0 sc0 ls0 ws0">The script starts by removing the current iptables conguration and enables IP </div><div class="t m0 x3 hd y1be2 ff4 fs7 fc0 sc0 ls0 ws0">forwarding on the host with the follo<span class="_ _0"/>wing command:</div><div class="t m0 x3 h44 y1be3 fff fse fc0 sc0 ls0 ws0">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</div><div class="t m0 x4 hd y1be4 ff4 fs7 fc0 sc0 ls0 ws0">The real magic within this script is the follo<span class="_ _0"/>wing command. This redirects an<span class="_ _0"/>y </div><div class="t m0 x3 hd y1be5 ff4 fs7 fc0 sc0 ls0 ws0">TCP port between the range specied with 1:65535 to our server<span class="_ _2"/>. Thus, this allo<span class="_ _0"/>ws </div><div class="t m0 x3 hd y1be6 ff4 fs7 fc0 sc0 ls0 ws0">our server to respond to an<span class="_ _0"/>y request for which we’<span class="_ _0"/>v<span class="_ _0"/>e congured a listening server<span class="_ _2"/>. </div><div class="t m0 x3 hd y1be7 ff4 fs7 fc0 sc0 ls0 ws0">Be sure to observe the trafc for an<span class="_ _0"/>y protocols for which you hav<span class="_ _0"/>e not created a fak<span class="_ _0"/>e </div><div class="t m0 x3 hd y1be8 ff4 fs7 fc0 sc0 ls0 ws0">server<span class="_ _2"/>. There may be an opportunity to assign a f<span class="_ _0"/>ake server on another listening port </div><div class="t m0 x3 hd y1be9 ff4 fs7 fc0 sc0 ls0 ws0">and respond to legitimate client requests.</div><div class="t m0 x3 h40 y1bea fff fs5 fc0 sc0 ls0 ws0">iptables -t nat -A PREROUTING -p tcp --dport 1:65535 -j DNAT --to-destination </div><div class="t m0 x3 h40 y1beb fff fs5 fc0 sc0 ls0 ws0">10.0.0.1</div><div class="t m0 x3 h4 y1bec ff2 fs1 fc0 sc0 ls0 ws0">Access Point Fake Ser<span class="_ _1"/>vers</div><div class="t m0 x3 hd y1bed ff4 fs7 fc0 sc0 ls0 ws0">The fake serv<span class="_ _0"/>ers are easy to congure using the Metasploit auxiliary modules. The </div><div class="t m0 x3 hd y1bee ff4 fs7 fc0 sc0 ls0 ws0">ARAP package comes with a metasploit.rc le to load all of the av<span class="_ _0"/>ailable f<span class="_ _0"/>ake </div></div><div class="pi" data-data="{&#34;ctm&#34;:[1.209373,0.000000,0.000000,1.209373,0.000000,0.000000]}"/></div></div></body></html>